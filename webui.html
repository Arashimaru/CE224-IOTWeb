<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ESP32 Nhà Thông Minh Pro</title>
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <style>
    :root{--bg:#0a0e1a;--card:#141824;--accent:#00d4ff;--on:#00ff88;--off:#ff3b30}
    body{margin:0;font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#0f1425,#1a2340);color:#e0f0ff;min-height:100vh}
    .container{max-width:1200px;margin:0 auto;padding:15px}
    header{text-align:center;padding:30px 0;color:var(--accent);text-shadow:0 0 30px rgba(0,212,255,.6)}
    .time{font-size:1.5rem;margin-top:10px;font-weight:500}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(360px,1fr));gap:25px;margin-top:20px}
    .card{background:var(--card);border-radius:24px;padding:30px;box-shadow:0 15px 40px rgba(0,0,0,.7);border:1px solid rgba(0,212,255,.2)}
    .card h2{text-align:center;padding:15px;margin:-30px -30px 20px;background:rgba(0,212,255,.1);color:var(--accent);border-radius:24px 24px 0 0;font-size:1.8rem}
    .sensor-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;text-align:center;margin-top:20px}
    .sensor-item img{width:100px;height:100px;object-fit:contain;filter:drop-shadow(0 0 20px var(--accent))}
    .value{font-size:3.2rem;font-weight:bold;color:var(--accent);text-shadow:0 0 15px var(--accent)}
    .label{font-size:1.2rem;opacity:0.9}
    .device{display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,.05);border-radius:20px;padding:20px;margin:15px 0}
    .device img{width:110px;height:110px;object-fit:contain}
    .device-info h3{margin:0;font-size:1.7rem}
    .status{font-size:1.4rem;margin-top:8px}
    button{width:90px;height:90px;border:none;border-radius:50%;font-size:2rem;cursor:pointer;box-shadow:0 10px 30px rgba(0,0,0,.6);transition:.3s}
    .btn-on{background:var(--on);color:#000}
    .btn-off{background:var(--off);color:#fff}
    button:active{transform:scale(0.9)}
    .chart-container{grid-column:1/-1;background:var(--card);border-radius:24px;padding:20px;box-shadow:0 15px 40px rgba(0,0,0,.7);margin-top:20px}
    #status{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);padding:14px 40px;border-radius:50px;background:rgba(0,0,0,.8);backdrop-filter:blur(10px);font-weight:bold;z-index:999}
    .connected{color:var(--on)}.disconnected{color:var(--off)}
  </style>
</head>
<body>
  <div class="container">
    <header><h1>Nhà Thông Minh ESP32 Pro</h1><div class="time" id="clock"></div></header>
    <div class="grid">
      <!-- Cảm biến -->
      <div class="card">
        <h2>Cảm Biến Môi Trường</h2>
        <div class="sensor-grid">
          <div class="sensor-item">
            <img src="/nhietdo.png" alt="Nhiệt độ">
            <div class="value" id="nhietdo">--</div><div class="label">°C</div>
          </div>
          <div class="sensor-item">
            <img src="/doam.png" alt="Độ ẩm">
            <div class="value" id="doam">--</div><div class="label">%</div>
          </div>
          <div class="sensor-item">
            <img src="/gas.png" alt="Khí gas">
            <div class="value" id="khoi">--</div><div class="label">ppm</div>
          </div>
        </div>
      </div>

      <!-- Điều khiển -->
      <div class="card">
        <h2>Điều Khiển Thiết Bị</h2>
        <div style="padding:20px">
          <div class="device">
            <img src="/den.png" id="imgDen">
            <div class="device-info"><h3>ĐÈN</h3><div class="status" id="statusDen">ĐÃ TẮT</div></div>
            <button id="btnDen" class="btn-off">Off</button>
          </div>
          <div class="device">
            <img src="/quat.png" id="imgQuat">
            <div class="device-info"><h3>QUẠT</h3><div class="status" id="statusQuat">ĐÃ TẮT</div></div>
            <button id="btnQuat" class="btn-off">Off</button>
          </div>
        </div>
      </div>

      <!-- Biểu đồ -->
      <div class="chart-container"><div id="chart-temperature" style="width:100%;height:340px"></div></div>
      <div class="chart-container"><div id="chart-humidity" style="width:100%;height:340px"></div></div>
      <div class="chart-container"><div id="chart-smoke" style="width:100%;height:340px"></div></div>
    </div>
  </div>

  <div id="status" class="disconnected">Đang kết nối ESP32...</div>

<script>
// ĐỔI IP ESP32 CỦA BẠN VÀO ĐÂY
const ESP_IP = "192.168.1.168";
const ws = new WebSocket(`ws://${ESP_IP}:81`);

// Đồng hồ
function updateClock(){
  const n = new Date();
  const o = {weekday:'long',year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit'};
  document.getElementById("clock").textContent = n.toLocaleDateString('vi-VN',o).replace(', ',' • ');
}
setInterval(updateClock,1000); updateClock();

// Highcharts
const chartT = Highcharts.chart('chart-temperature',{chart:{type:'line',backgroundColor:'rgba(20,24,36,.95)',borderRadius:20},
  title:{text:'Nhiệt độ theo thời gian',style:{color:'#fff'}},xAxis:{type:'datetime'},yAxis:{title:{text:'°C'}},
  series:[{name:'Nhiệt độ',data:[],color:'#ff6b6b'}],credits:{enabled:false}});
const chartH = Highcharts.chart('chart-humidity',{chart:{type:'line',backgroundColor:'rgba(20,24,36,.95)',borderRadius:20},
  title:{text:'Độ ẩm theo thời gian',style:{color:'#fff'}},xAxis:{type:'datetime'},yAxis:{title:{text:'%'}},
  series:[{name:'Độ ẩm',data:[],color:'#4ecdc4'}],credits:{enabled:false}});
const chartS = Highcharts.chart('chart-smoke',{chart:{type:'line',backgroundColor:'rgba(20,24,36,.95)',borderRadius:20},
  title:{text:'Khí gas / Khói (MQ-2)',style:{color:'#fff'}},xAxis:{type:'datetime'},yAxis:{title:{text:'ppm'}},
  series:[{name:'MQ-2',data:[],color:'#ffe66d'}],credits:{enabled:false}});

ws.onopen = ()=>{document.getElementById("status").textContent="Đã kết nối ESP32";document.getElementById("status").className="connected";}
ws.onclose = ()=>{document.getElementById("status").textContent="Mất kết nối – thử lại 5s...";document.getElementById("status").className="disconnected";setTimeout(()=>location.reload(),5000);}

ws.onmessage = (e)=>{
  const d = JSON.parse(e.data);
  const t = new Date().getTime();

  document.getElementById("nhietdo").textContent = d.nhietdo>=0 ? d.nhietdo.toFixed(1) : "--";
  document.getElementById("doam").textContent = d.doam>=0 ? d.doam.toFixed(1) : "--";
  document.getElementById("khoi").textContent = d.khoi;

  chartT.series[0].addPoint([t, d.nhietdo], true, chartT.series[0].data.length>60);
  chartH.series[0].addPoint([t, d.doam], true, chartH.series[0].data.length>60);
  chartS.series[0].addPoint([t, d.khoi], true, chartS.series[0].data.length>60);

  // Đèn
  if(d.den){
    document.getElementById("btnDen").className="btn-on"; document.getElementById("btnDen").innerHTML="On";
    document.getElementById("statusDen").textContent="ĐANG BẬT"; document.getElementById("statusDen").style.color="#00ff88";
    document.getElementById("imgDen").src="/denon.png";
  }else{
    document.getElementById("btnDen").className="btn-off"; document.getElementById("btnDen").innerHTML="Off";
    document.getElementById("statusDen").textContent="ĐÃ TẮT"; document.getElementById("statusDen").style.color="#888";
    document.getElementById("imgDen").src="/den.png";
  }

  // Quạt
  if(d.quat){
    document.getElementById("btnQuat").className="btn-on"; document.getElementById("btnQuat").innerHTML="On";
    document.getElementById("statusQuat").textContent="ĐANG CHẠY"; document.getElementById("statusQuat").style.color="#00ff88";
    document.getElementById("imgQuat").src="/quaton.png";
  }else{
    document.getElementById("btnQuat").className="btn-off"; document.getElementById("btnQuat").innerHTML="Off";
    document.getElementById("statusQuat").textContent="ĐÃ TẮT"; document.getElementById("statusQuat").style.color="#888";
    document.getElementById("imgQuat").src="/quat.png";
  }
};

document.getElementById("btnDen").onclick = ()=>toggle('den');
document.getElementById("btnQuat").onclick = ()=>toggle('quat');
function toggle(dev){
  const btn = document.getElementById("btn"+dev.charAt(0).toUpperCase()+dev.slice(1));
  const state = !btn.classList.contains("btn-on");
  ws.send(JSON.stringify({cmd:dev, state:state}));
}
</script>
</body>
</html>